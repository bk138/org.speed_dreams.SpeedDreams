app-id: org.speed_dreams.SpeedDreams
runtime: org.freedesktop.Platform
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
command: speed-dreams-2

finish-args:
  - --socket=wayland
  - --share=ipc
  - --socket=x11
  - --device=all
  - --persist=.speed-dreams-2
  - --socket=pulseaudio
  - --share=network
cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /share/gtk-doc
  - /share/man
  - /share/pkgconfig
  - '*.a'
  - '*.la'
  - '/share/speed-dreams-2/cmake/'
  
modules:
  - shared-modules/glu/glu-9.json
  #- shared-modules/udev/udev-175.json

  - name: freeglut
    buildsystem: cmake-ninja
    build-options:
      cflags: -fcommon
    sources:
      - type: archive
        url: https://sourceforge.net/projects/freeglut/files/freeglut/3.2.1/freeglut-3.2.1.tar.gz
        sha256: d4000e02102acaf259998c870e25214739d1f16f67f99cb35e4f46841399da68

  - name: jasper
    buildsystem: cmake-ninja
    config-opts:
    - -DCMAKE_BUILD_TYPE=Release
    - -DJAS_ENABLE_OPENGL=ON
    - -DJAS_ENABLE_LIBJPEG=ON
    - -DJAS_ENABLE_AUTOMATIC_DEPENDENCIES=OFF
    - -DCMAKE_SKIP_RPATH=ON
    - -DALLOW_IN_SOURCE_BUILD=ON
    sources:
      - type: archive
        url: https://github.com/jasper-software/jasper/archive/refs/tags/version-2.0.32.tar.gz
        sha256: a3583a06698a6d6106f2fc413aa42d65d86bedf9a988d60e5cfa38bf72bc64b9
        
  - name: openscenegraph
    buildsystem: cmake
    config-opts:
    - -DCMAKE_BUILD_TYPE=Release
    - -DLIB_POSTFIX=
    sources:
      - type: archive
        url: https://github.com/openscenegraph/OpenSceneGraph/archive/refs/tags/OpenSceneGraph-3.6.5.tar.gz
        sha256: aea196550f02974d6d09291c5d83b51ca6a03b3767e234a8c0e21322927d1e12

  - name: libxmu
    sources:
      - type: archive
        url: https://www.x.org/archive//individual/lib/libXmu-1.1.3.tar.bz2
        sha256: 9c343225e7c3dc0904f2122b562278da5fed639b1b5e880d25111561bac5b731
  
  - name: plib
    build-options:
      cflags: -fPIC
      cxxflags: -fPIC
    config-opts:
      - CXXFLAGS=-fPIC
    sources:
      - type: archive
        url: http://plib.sourceforge.net/dist/plib-1.8.5.tar.gz
        sha256: 485b22bf6fdc0da067e34ead5e26f002b76326f6371e2ae006415dea6a380a32
      - type: shell
        commands:
        - cp -p /usr/share/automake-*/config.{sub,guess} .

  - name: enet
    sources:
      - type: archive
        url: http://enet.bespin.org/download/enet-1.3.17.tar.gz
        sha256: a38f0f194555d558533b8b15c0c478e946310022d0ec7b34334e19e4574dcedc
  
  - name: speed-dreams2
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DSD_BINDIR=/app/bin
      - -DSD_DATADIR=/app/share/speed-dreams-2
      - -DSD_LIBDIR=/app/lib/speed-dreams-2
      - -DOPTION_OFFICIAL_ONLY=ON
    
    sources:
      - type: archive
        strip-components: 0
        url: https://downloads.sourceforge.net/sourceforge/speed-dreams/speed-dreams-src-base-2.2.3-r7616.tar.xz
        sha256: c67e48a083cd86f6c0062f0b38ed91a5d25274ea8aa656ee182f3f5074e96ff0

      - type: archive
        strip-components: 0
        url: https://downloads.sourceforge.net/sourceforge/speed-dreams/speed-dreams-src-hq-cars-and-tracks-2.2.3-r7616.tar.xz
        sha256: 06eaf2094bc10fbaca980a4236c4e444dd14275aba3f7b1d62b4b3a53a9d4c77

      - type: archive
        strip-components: 0
        url: https://downloads.sourceforge.net/sourceforge/speed-dreams/speed-dreams-src-more-hq-cars-and-tracks-2.2.3-r7616.tar.xz
        sha256: 19208761b252df9db200c733cecb3bb584905f02d057af2bbff5e4c86cbe1a86

      - type: archive
        strip-components: 0
        url: https://downloads.sourceforge.net/sourceforge/speed-dreams/speed-dreams-src-wip-cars-and-tracks-2.2.3-r7616.tar.xz
        sha256: aff20e49ff94660d9ef962079f640d0ceeaa414869209be1ec41768d0ee5cb20

        # Patch - the fonts for OSG-hud were not being installed
      #- type: patch
      #  path: osg-hud-fonts-2.2.2.patch

        # Patch - the images for OSG-sky were not being installed
      #- type: patch
      #  path: osg-sky-2.2.2.patch

      - type: patch
        path: speeddreams-aarch64.patch

      - type: file
        path: org.speed_dreams.SpeedDreams.desktop
        
      - type: file
        path: org.speed_dreams.SpeedDreams.appdata.xml
      
    post-install:
      - install -Dm644 org.speed_dreams.SpeedDreams.desktop /app/share/applications/org.speed_dreams.SpeedDreams.desktop
      - install -Dm644 /app/share/speed-dreams-2/data/icons/icon.png /app/share/icons/hicolor/128x128/apps/org.speed_dreams.SpeedDreams.png
      - install -Dm644 org.speed_dreams.SpeedDreams.appdata.xml /app/share/appdata/org.speed_dreams.SpeedDreams.appdata.xml
